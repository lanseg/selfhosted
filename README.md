# selfhosted-docker

Sources and docker configuration for personal "ecosystem". Now the "ecosystem" contains of the following services:
* OpenConnect &mdash; for connecting to the local network from the outside
* Certbot &mdash; for refreshing OpenConnect certificate
* Tor, i2pd and Privoxy for privacy
* Home Assistant &mdash; for managing my smart lamps

There is something common between all services:
* Built from the latest source
* Use alpine:latest as a base image

And nginx webserver provides a frontend for the home assistant and other web-enabled things.

## Global configuration
If the docker service is configured to run on system startup (e.g. by doing ```sudo systemctl enable docker```), then it will automatically start all the services after reboot

## Service details
It should be enough to run ```docker compose up``` to start the whole system. Some of the services can start as is, but others (e.g. vpn server) require extra configuration and docker capabilities.

## Openconnect
### Building
```bash
docker build -t ocserv .
```

### Running
```bash
docker run --name ocserv -v ./conf:/ocserv/conf -v  /etc/letsencrypt/archive:/cert --sysctl net.ipv4.ip_forward=1 --cap-add=NET_ADMIN -p 443:443 ocserv
```

### Configuration

Docker container volumes and parameters:
* /conf &mdash; folder with the config files (e.g. ocserv.conf, passwd, etc)
* /cert &mdash; folder with the certificates, selfsigned or generated by letsencrypt
* --cap-add=NET_ADMIN &mdash; capability that allows Docker to creeate tun devices
* --sysctl net.ipv4.ip_forward=1 &mdash; to enable ip forwarding

Configuring users:
```bash
# Add a new user
docker exec -it selfhosted-ocserv-1 /ocserv/dist/bin/ocpasswd \
  --passwd=/ocserv/conf/passwd <USERNAME>

# Reload passwd file
docker exec -it selfhosted-ocserv-1 /ocserv/dist/bin/occtl reload
```

Configuring routes:
```bash
iptables -t nat -A POSTROUTING -j MASQUERADE -s 10.10.11.0/24
```
That is a part of entrypoint script.

## Certbot
### Building
```bash
docker build -t certbot .
```

### Running
```bash
docker run -e DOMAINS=my.domain.name -e EMAIL=my_email@host.domain -e DRY_RUN=false -it -p 80:80 -v ./data:/certbot/data certbot
```

### Configuration
I use http confirmation to confirm my domain ownership when obtaining a certificate, and using 80 port is inevitable. But the service starts and stops, so it won't block the port for other applications. Other required options are:
* DOMAINS &mdash; to define domain names assigned to this machine
* EMAIL &mdash; owner's email
* /certbot/data volume &mdash; a volume to store the certificates and work data.

## i2pd
### Building
```bash
docker build -t i2pd .
```

### Running
```bash
docker run -v ./volumes/i2pd:/home/i2pd -p 4447:4447  i2pd
```

### Configuration
i2pd will use the volume to store working data, peer information, etc, which will make startup and bootstrapping faster. Also, the main config, ```i2pd.conf```, lives there. Minimal configuration could look like this:
```ini
log = true

[httpproxy]
enabled = false

[socksproxy]
port = 4447
address = 0.0.0.0

[sam]
enabled = true
```

## Tor
### Building
```bash
docker build -t tor .
```

### Running
```bash
docker run -v ./volumes/tor:/config -p 4447:4447  tor
```

### Configuration

Lives in ```volumes/tor/torrc``` This simple configuration opens Socks5 proxy port for the docker network, so privoxy could access it.
```
SocksPort 0.0.0.0:9050
SOCKSPolicy accept 172.17.0.0/16
SOCKSPolicy reject *
DataDirectory /tor/var/lib/tor
Log notice syslog
```

## Privoxy
Privoxy needed to create a single proxy point for tor and i2p networks.

### Building
```bash
docker build -t privoxy .
```

### Running
```bash
docker run -v ./volumes/privoxy:/config/ -p 8118:8118  privoxy
```

### Configuration
```
listen-address  0.0.0.0:8118

forward-socks5 .i2p i2pd:4447
forward-socks5 / tor:9050
```

## Home assistant
### Building
```bash
docker build -t homeassistant .
```

### Running
```bash
docker run -v ./volumes/ha-config:/config -p 8123:8123 hasss
```

### Configuration
Lives in ```volumes/ha-config/configuration.yaml```, allows to access home assistant from the Docker network.

```yaml
---
default_config:

# frontend
frontend:

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 172.17.0.1
    - 172.18.0.1
    - 172.20.0.1
    - 127.0.0.1
```
